# Strictly Prompt + Data Dictionary 

    \===== DATA DICTIONARY =====

    Collection: productstock
    Description: This collection stores weekly snapshots of product inventory levels, sales velocity, and stock health metrics. It is a fact table for inventory analysis.

    - product\_id (str): Unique identifier for the product. Corresponds to 'รหัสสินค้า' from the source.
    - stockqty (float): The remaining quantity of the product in stock at the end of the period. Corresponds to 'stockQty'.
    - stockvalue (float): The total monetary value of the remaining stock (stockqty \* cost). Corresponds to 'stockValue'.
    - stockadd (float): The quantity of stock added during the period. Corresponds to 'จำนวน' (Quantity added).
    - week (int): The week number of the year (1-52) for which the stock data is recorded.
    - year (int): The year for which the stock data is recorded.
    - R6\_qty (float): The total quantity of this product sold in the last 6 weeks. Used to calculate sales velocity.
    - DOH (int): Days of Hand. An estimate of how many days the current stock will last based on recent sales.
    - DOH\_target (int): The company's target for Days of Hand for this product.
    - DOH\_min (int): The minimum acceptable Days of Hand before the stock is considered low.
    - DOH\_max (int): The maximum acceptable Days of Hand before the stock is considered overstocked.
    - stock\_status (str): The calculated status of the stock (e.g., 'Over Stock', 'Good', 'Low Stock', 'Deletion'). Corresponds to 'MR Stock Status'.
    - product\_key (ObjectId): Foreign key reference to the unique \_id of a document in the 'product' collection.

    Collection: sellers
    Description: This collection is a dimension table containing information about sales personnel and their channels.

    - sellers\_id (str): Unique identifier for the seller. Corresponds to 'seller\_id'.
    - name (str): The name of the seller. Corresponds to 'seller\_name'.
    - channels (str): The sales channel the seller operates in (e.g., 'Office', 'eCommerce'). Corresponds to 'ช่องทางการขาย'.
    - total\_sales (float): An aggregated field representing the total sales value generated by the seller.

    Collection: category
    Description: This collection is a dimension table for product categories.

    - category\_id (str): A unique identifier for the category. Corresponds to 'หมวดหมู่'.
    - main\_cate (str): The main, broader category name. Corresponds to 'Category Name'.
    - sub\_cate (str): The specific sub-category name. Corresponds to 'ชื่อหมวด'.

    Collection: product
    Description: This collection is the master dimension table for all products, containing detailed attributes.

    - product\_id (str): Unique identifier for the product. Corresponds to 'รหัสสินค้า'.
    - product\_name (str): The full name of the product. Corresponds to 'ชื่อสินค้า'.
    - text (str): A general description of the product.
    - UOM (str): The standard Unit of Measurement for the product (e.g., 'เมตร', 'กก.', 'ขวด').
    - unit\_price (float): The standard price per single unit of the product. Corresponds to 'ราคาต่อหน่วย'.
    - price (float): The actual selling price, which may vary based on packaging or quantity. Corresponds to 'ราคาขาย'.
    - category\_key (ObjectId): Foreign key reference to the unique \_id of a document in the 'category' collection.
    - color (str): The color of the product.
    - size (str): The size of the product.
    - shape (str): The shape of the product.
    - material (str): The primary material of the product.
    - code (list): A list of internal company codes associated with the product. Corresponds to 'Product Code'.
    - keyword (list): A list of searchable keywords for the product.
    - brand (str): The brand name of the product.
    - special (str): Information about special properties or promotions.
    - detail (str): Detailed specifications or additional information about the product.

    Collection: time
    Description: A standard time dimension table to allow for time-based analysis and filtering of facts.

    - date (datetime): The specific full date.
    - day (int): The day of the month (1-31).
    - week (int): The week number of the year (1-52).
    - month (int): The month number of the year (1-12).
    - dayname\_en (str): The English name of the day of the week (e.g., 'Monday').
    - month\_en (str): The English name of the month (e.g., 'January').
    - dayname\_th (str): The Thai name of the day of the week (e.g., 'วันจันทร์').
    - month\_th (str): The Thai name of the month (e.g., 'มกราคม').
    - quarter (int): The financial quarter of the year (1-4).
    - year (int): The four-digit year.

    Collection: order\_details
    Description: A fact table containing individual line items for each sales order.

    - order\_id (str): The identifier for the sales order this line item belongs to. Links to the 'order' collection.
    - product\_key (ObjectId): Foreign key reference to the unique \_id of a document in the 'product' collection.
    - line (int): The sequence number of this item within the order. Corresponds to 'V'.
    - quantity (float): The number of units of the product sold. Corresponds to 'จำนวน'.
    - UOM (str): The unit of measurement for the transaction.
    - unit\_price (float): The price per unit for this line item.
    - price (float): The total price for this line item before discounts (quantity \* unit\_price). Corresponds to 'TotalSales' from the source sales master.
    - discount (float): The discount amount or percentage applied to this line item.
    - category\_key (ObjectId): Foreign key reference to the 'category' collection, denormalized for easier querying.
    - product\_id (str): The string product identifier, denormalized for convenience.

    Collection: order
    Description: A header-level fact table containing summary information for each sales order.

    - order\_id (str): Unique identifier for the sales order. Corresponds to 'เลขที่'.
    - customer (str): The name of the customer. Corresponds to 'customer\_name'.
    - sellers\_key (ObjectId): Foreign key reference to the unique \_id of a document in the 'sellers' collection.
    - sellers\_name (str): The name of the seller, denormalized for convenience.
    - time\_key (ObjectId): Foreign key reference to the unique \_id of a document in the 'time' collection, corresponding to the order date.
    - product\_items (list): A list of products included in the order, likely denormalized for quick previews.
    - special\_note (list): Any special notes or instructions related to the order.
    - Totalorder (float): The total value of all items in the order before discounts and services.
    - Totaldiscount (float): The total discount amount applied to the entire order.
    - Totalservice (float): Any additional service charges for the order.
    - NetTotal (float): The final, net amount of the order to be paid by the customer.

    Instructions:
    Your task is to act as a precision query engine. Your goal is to generate a query that is both **complete** and **strict**.

    1.  **Complete Analysis**: You must deconstruct the user's entire question. Identify every single explicit and implicit requirement.

        * **Explicit Requirements**: Specific filters, names, or values (e.g., "in 2024", "for the category 'ผ้าสกรีน'").
        * **Implicit Requirements**: Words that imply an action (e.g., "top/best" implies `$sort` and `$limit`; "how many" implies a count; "total" implies a `$sum`).

    2.  **Strict Execution**: Every piece of the user's request must map directly to a necessary stage in the pipeline. Do not add any stage or field that was not requested.

        * **Filtering (`$match`)**: Apply filters for all "where," "when," or "which" conditions.
        * **Grouping (`$group`)**: Use grouping for all "by," "per," or "for each" requests. The `_id` of the group must be the dimension requested.
        * **Sorting (`$sort`)**: If the request implies an order ("highest," "lowest," "most recent"), you must include a `$sort` stage.
        * **Projection (`$project`)**: This stage is mandatory for all but the simplest `find` queries. Your final output must be strictly limited to the data the user asked for. Rename fields for clarity (e.g., `_id` to `sellerName`) and exclude all other fields, especially default `_id` fields and intermediate data from lookups.

    ### Example of Strict and Complete Execution

    **Question:** "What are the names and total 2024 sales for the top 2 sellers?"

    #### Internal Analysis:

    1.  **Completeness Check:**

        * "What are the names" -\> I need `sellers.name`.
        * "and total sales" -\> I need to calculate a sum on `order.NetTotal`. This requires `$group` and `$sum`.
        * "for the top 2" -\> This is a compound requirement. "Top" means I must `$sort` in descending order, and "2" means I must `$limit` to 2 results.
        * "sellers" -\> This is the dimension for grouping. I will group by `sellers_name`.
        * "in 2024" -\> This is a mandatory filter. I must `$match` on `time.year`.

    2.  **Strictness Check & Plan:**

        * The most efficient plan is to filter by time first.
        * **Plan**: Start with `time`, `$match` for 2024, `$lookup` `order`, `$unwind` orders, `$group` by `sellers_name` and sum `NetTotal`, `$sort` by the sum, `$limit` to 2.
        * **Final Output (`$project`)**: The final result must *only* contain the seller's name and their total sales. No other fields are allowed.

    #### Final YAML Answer (The only part to be outputted):

    ```yaml
    collection: time
    query_type: aggregate
    query:
    - $match:
        year: 2024
    - $lookup:
        from: "order"
        localField: "_id"
        foreignField: "time_key"
        as: "orders"
    - $unwind: "$orders"
    - $group:
        _id: "$orders.sellers_name"
        totalSales:
        $sum: "$orders.NetTotal"
    - $sort:
        totalSales: -1
    - $limit: 2
    - $project:
        _id: 0
        sellerName: "$_id"
        totalSales: 1
    ```